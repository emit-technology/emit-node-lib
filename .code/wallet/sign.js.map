{"version":3,"file":"sign.js","sourceRoot":"","sources":["../../src/wallet/sign.ts"],"names":[],"mappings":"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","sourcesContent":["import * as ed from \"@noble/ed25519\";\nimport { Block, PrepareBlock, Sign } from \"./types\";\n// import { randomBytes } from \"crypto\";\nimport { ED_BASE } from \"./serial/constants\";\nimport { fromAddressBytes } from \"./address\";\nimport BlockSerial from \"./serial/block\";\n\nconst BN = require(\"bn.js\");\nconst b2b = require(\"blake2b\");\n\nexport function blake2bHash(personal: string, data: Buffer): Buffer {\n  const p = Buffer.alloc(16, 0);\n  p.fill(personal, 0, personal.length);\n  const hash = b2b(64, null, null, p);\n  const out = hash.update(data);\n  const buf = out.digest(\"binary\");\n  return Buffer.from(buf);\n}\n\nexport function prepareBlockToHash(prepareBlock: PrepareBlock): string {\n  const PREPARE_BLOCK_PERSONAL = \"EMIT-PREPARE-BLK\";\n  const addrBuf = fromAddressBytes(prepareBlock.address);\n  const blkHashBuf = Buffer.from(blockToHash(prepareBlock.blk), \"hex\");\n  const bufConcat = Buffer.concat([addrBuf, blkHashBuf]);\n  const buf = blake2bHash(PREPARE_BLOCK_PERSONAL, bufConcat);\n  return buf.slice(0, 32).toString(\"hex\");\n}\n\nexport function blockToHash(block: Block) {\n  const BLOCK_HASH_PERSONAL = \"EMIT-BLOCK-HASH\";\n  const buf = blake2bHash(BLOCK_HASH_PERSONAL, new BlockSerial(block).serial());\n  return buf.slice(0, 32).toString(\"hex\");\n}\n\nexport function toScalar(bytes: Uint8Array): bigint {\n  return mod(bytesToNumberLE(bytes), ed.CURVE.n);\n}\n\nexport function bytesToNumberLE(uint8a: Uint8Array): bigint {\n  let value = BigInt(0);\n  for (let i = 0; i < uint8a.length; i++) {\n    value += BigInt(uint8a[i]) << (BigInt(8) * BigInt(i));\n  }\n  return value;\n}\nexport function mod(a: bigint, b: bigint = ed.CURVE.n) {\n  const res = a % b;\n  return res >= BigInt(0) ? res : b + res;\n}\n\nexport function signPrepareBlock(h: string, privateKey: Buffer): Sign {\n  const m = Buffer.from(h, \"hex\");\n  const r = toScalar(Buffer.from(\"4acf74881b23d22edc471e14a9e2acc6c9712bc105b1fd922b810672052c9a02\",\"hex\"));\n  const R = ED_BASE.multiply(r);\n  const sk = toScalar(privateKey.slice(0, 32));\n\n  const concatBuf = Buffer.concat([m, R.toRawBytes()]);\n  let hash = blake2bHash(\"EMIT-SIGN\", concatBuf);\n  const e = toScalar(hash.slice(0, 32));\n\n  console.log(\"sign e:\", e);\n  const s = new BN(mod(mod(sk * e) + r)).toArrayLike(Buffer, \"le\");\n  const sBuf = Buffer.alloc(32, 0);\n  sBuf.fill(s, 0, s.length);\n  return {\n    r:  R.toHex(),\n    s: sBuf.toString(\"hex\"),\n  };\n}\n\nexport interface MsgWithSign<T> {\n  data: T;\n  sign: SignWithAddress;\n}\n\nexport interface SignWithAddress {\n  addr: string;\n  sign: Sign;\n}\n"]}